{% extends "base.html" %}

{% block title %}Integrations - YoppyChat AI{% endblock %}

{% block page_styles %}
<style>
    .integration-hub {
        text-align: center;
        padding: 2rem;
    }
    .integration-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 1.5rem;
        margin-top: 2rem;
        text-align: left;
    }
    .integration-card {
        background: var(--surface-light);
        border: 1px solid var(--neutral-200);
        border-radius: var(--radius-lg);
        padding: 1.5rem;
        text-decoration: none;
        color: var(--text-primary);
        transition: all 0.2s ease-in-out;
        display: flex;
        flex-direction: column;
    }
    .integration-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-md);
        border-color: var(--accent-primary);
    }
    .card-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        font-size: 1.2rem;
        font-weight: 600;
    }
    .card-icon {
        width: 32px;
        height: 32px;
    }
    .card-description {
        margin: 1rem 0;
        color: var(--text-secondary);
        flex-grow: 1;
    }
    .card-footer {
        font-weight: 500;
        color: var(--accent-primary);
    }

    /* --- NEW: Status Badge Styles --- */
    .status-badge {
        margin-left: auto; /* Pushes the badge to the right */
        font-size: 0.8rem;
        font-weight: 600;
        padding: 4px 12px;
        border-radius: var(--radius-full);
        background-color: var(--surface-medium);
        color: var(--text-secondary);
        border: 1px solid var(--neutral-200);
    }
    .status-badge.active {
        background-color: #e8f5e9; /* Light green */
        color: #2e7d32; /* Dark green */
        border-color: #a5d6a7;
    }
    html[data-theme='dark'] .status-badge {
        background-color: var(--surface-dark);
        border-color: var(--neutral-300);
    }
    html[data-theme='dark'] .status-badge.active {
        background-color: #1c3b1e;
        color: #a5d6a7;
        border-color: #2e7d32;
    }
        .links-page { padding: 2rem; }
    .back-link { 
        display: inline-block; 
        margin-bottom: 1.5rem; 
        color: var(--text-secondary); 
        text-decoration: none; 
        font-weight: 500; 
    }
    .back-link:hover { color: var(--text-primary); }
    .channel-link-card {
        background: var(--surface-light);
        border: 1px solid var(--neutral-200);
        border-radius: var(--radius-lg);
        padding: 1.5rem;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 1.5rem;
    }
    .channel-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        object-fit: cover;
    }
    .link-details {
        flex-grow: 1;
    }
    .channel-name {
        font-weight: 600;
        font-size: 1.1rem;
    }
    .code-block-wrapper {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }
    .code-block-input {
        font-family: monospace;
        background: var(--surface-medium);
        border: 1px solid var(--neutral-200);
        padding: 0.75rem;
        border-radius: var(--radius-sm);
        flex-grow: 1;
        font-size: 0.9rem;
    }
    .copy-btn {
        padding: 0.5rem 1rem;
        flex-shrink: 0;
    }
    .no-channels-notice {
        text-align: center;
        padding: 3rem;
        background-color: var(--surface-medium);
        border-radius: var(--radius-lg);
        border: 2px dashed var(--neutral-200);
    }
    .channel-link-card-new {
    background: var(--surface-light);
    border: 1px solid var(--neutral-200);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: var(--shadow-sm);
}
.channel-link-card-new .card-header {
    display: flex;
    align-items: center;
    gap: 1.5rem;
    padding-bottom: 1rem;
    margin-bottom: 1rem;
    border-bottom: 1px solid var(--neutral-200);
}
.channel-link-card-new .card-stats h4 {
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 1rem;
}
.card-stats .stat-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 1rem;
    padding: 0.75rem 0;
    border-bottom: 1px solid var(--neutral-200);
}
.card-stats .stat-item:last-child {
    border-bottom: none;
}
.stat-item .stat-label {
    color: var(--text-secondary);
    font-weight: 500;
}
.stat-item .stat-value {
    color: var(--text-primary);
    font-weight: 600;
    font-family: 'Onest', sans-serif;
}
.stat-label {
    display: flex;
    align-items: center;
    gap: 8px; /* Creates space between the label text and the icon */
}
.info-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background-color: var(--neutral-300);
    color: var(--surface-light);
    font-size: 12px;
    font-weight: 700;
    font-family: serif; /* Gives a nice look to the 'i' */
    cursor: pointer;
    position: relative;
    user-select: none; /* Prevents text selection on mobile tap */
}

/* Tooltip Bubble */
.info-icon::before {
    content: attr(data-tooltip);
    position: absolute;
    bottom: 150%;
    left: 50%;
    transform: translateX(-50%);
    width: 240px;
    background-color: var(--text-primary);
    color: var(--surface-light);
    padding: 10px;
    border-radius: var(--radius-md);
    font-size: 0.85rem;
    font-family: 'Figtree', sans-serif;
    font-weight: 500;
    line-height: 1.5;
    text-align: center;
    z-index: 10;
    /* Hidden by default */
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.2s ease;
    pointer-events: none;
}

/* Show on hover (desktop) or when .active class is added by JS (mobile) */
.info-icon:hover::before,
.info-icon.active::before {
    opacity: 1;
    visibility: visible;
}
</style>
{% endblock %}

{% block content %}
<div class="integration-hub">
    <h1>Integrations</h1>
    <p>Connect YoppyChat with your favorite apps to extend its power.</p>

    <div class="integration-grid">
        <a href="{{ url_for('discord_dashboard') }}" class="integration-card">
            <div class="card-header">
                        <img src="{{ url_for('static', filename='images/logo/discord-icon.svg') }}" 
             alt="Discord Logo" class="card-icon">
                <span>Discord</span>
                {% if discord_is_active %}
                    <span class="status-badge active">Active</span>
                {% else %}
                    <span class="status-badge">Not Connected</span>
                {% endif %}
            </div>
            <p class="card-description">Manage the official YoppyChat bot or create your own fully branded bot for your server.</p>
            <div class="card-footer">Manage Discord →</div>
        </a>

        <a href="{{ url_for('telegram_dashboard') }}" class="integration-card">
            <div class="card-header">
                <img src="{{ url_for('static', filename='images/logo/telegram.svg') }}" 
                     alt="Telegram Logo" class="card-icon">
                <span>Telegram</span>
                {% if telegram_is_active %}
                    <span class="status-badge active">Active</span>
                {% else %}
                    <span class="status-badge">Not Connected</span>
                {% endif %}
            </div>
            <p class="card-description">Connect your personal account or add the bot to a group chat for Q&A on the go.</p>
            <div class="card-footer">Manage Telegram →</div>
        </a>
    </div>
</div>
<div class="links-page">

    <h1>Creator Share Links</h1>
    <p>Share these public links to allow anyone to chat with the AI persona of your channels.</p>

    <div class="links-container" style="margin-top: 2rem;">
        {% if saved_channels %}
            {% for name, channel in saved_channels.items() %}
                <div class="channel-link-card-new">
                    <div class="card-header">
                        <img src="{{ channel.channel_thumbnail }}" alt="{{ name }}" class="channel-avatar">
                        <div class="link-details">
                            <div class="channel-name">{{ name }}</div>
                            <div class="code-block-wrapper">
                                <input type="text" class="code-block-input" value="{{ url_for('public_chat_page', channel_name=name, _external=True) }}" readonly>
                                <button class="btn btn-secondary copy-btn" onclick="copyShareLink(this)">Copy</button>
                            </div>
                        </div>
                    </div>

                    <div class="card-stats">
                        <div class="stat-item">
                            <span class="stat-label">
                                Referrals
                                <span class="info-icon" data-tooltip="Total new users who signed up using this channel's public link.">i</span>
                            </span>
                            <span class="stat-value">
                                {{ channel.stats.referrals }} 
                                <span style="color: var(--text-muted); font-weight: 500;" data-tooltip="How many of your referred users have upgraded to a paid plan.">
                                    ({{ channel.stats.paid_referrals }} Subscribed)
                                </span>
                            </span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">
                                Creator MRR
                                <span class="info-icon" data-tooltip="Your estimated monthly commission from your referred users' subscriptions.">i</span>
                            </span>
                            <span class="stat-value">${{ "%.2f"|format(channel.stats.creator_mrr) }} / month</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">
                                Current Adds
                                <span class="info-icon" data-tooltip="The total number of users who currently have this channel in their personal list.">i</span>
                            </span>
                            <span class="stat-value">{{ channel.stats.current_adds }}</span>
                        </div>
                    </div>
                </div> {% endfor %}
        {% else %}
            <div class="no-channels-notice">
                <p>You haven't processed any channels yet.</p>
                <a href="{{ url_for('channel') }}" class="btn btn-primary" style="margin-top: 1rem;">Process Your First Channel</a>
            </div>
        {% endif %}
    </div>
</div>

{% endblock %}
{% block page_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // This script handles the tooltip clicks for mobile users
    const dashboardContainer = document.querySelector('.links-container');
    if (dashboardContainer) {
        // Use event delegation for efficiency
        dashboardContainer.addEventListener('click', function(e) {
            if (e.target.classList.contains('info-icon')) {
                e.stopPropagation(); // Prevent the document click listener from firing immediately

                // Deactivate any other active icons
                document.querySelectorAll('.info-icon.active').forEach(icon => {
                    if (icon !== e.target) {
                        icon.classList.remove('active');
                    }
                });
                // Toggle the active state on the clicked icon
                e.target.classList.toggle('active');
            }
        });
    }

    // Add a single listener to the document to close any open tooltips
    document.addEventListener('click', function(e) {
        if (!e.target.classList.contains('info-icon')) {
            document.querySelectorAll('.info-icon.active').forEach(icon => {
                icon.classList.remove('active');
            });
        }
    });
});
</script>
{% endblock %}