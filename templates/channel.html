{% extends "base.html" %}
{% from "_macros.html" import render_dashboard_channel_card %}

{% block title %}Process Channel - YoppyChat AI{% endblock %}

{% block page_styles %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/channel.css') }}">
{% endblock %}

{% block content %}
<div class="hero-section">
    <div class="hero-content">
        <!-- <div class="hero-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M22.54 6.42a2.78 2.78 0 0 0-1.94-2C18.88 4 12 4 12 4s-6.88 0-8.6.42a2.78 2.78 0 0 0-1.94 2A29 29 0 0 0 1 11.75a29 29 0 0 0 .54 5.33A2.78 2.78 0 0 0 3.46 19c1.72.42 8.6.42 8.6.42s6.88 0 8.6-.42a2.78 2.78 0 0 0 1.94-2A29 29 0 0 0 23 11.75a29 29 0 0 0-.46-5.33z"/>
                <path d="M10 15.25l5-3.5-5-3.5v7z"/>
            </svg>
        </div> -->
        <h1 class="hero-title">Add Your YouTube Channel</h1>
        <p class="hero-subtitle">YoppyChat studies every video youâ€™ve ever publishedâ€”your insights, stories, and signature styleâ€”then lets viewers chat with an AI version of you whenever inspiration strikes.
</p>

        <div class="plan-usage-display">
            {% if user_status %}
                {% if user_status.plan_id == 'admin_testing' %}
                    <p>You are on the Admin Testing plan. You can add <strong>1</strong> channel.</p>
                {% elif user_status.plan_id == 'community_member' %}
                    <p>As a community member, you can chat with shared channels. To add your own personal channels, please upgrade to a member plan.</p>
                {% else %}
                    <p>Your current plan: <strong>{{ user_status.plan_name }}</strong>. You can add up to <strong>{{ user_status.limits.max_channels }}</strong> personal channels.</p>
                {% endif %}
            {% endif %}
        </div>

        <form id="channelForm" class="channel-form" onsubmit="return false;">
            <div class="form-group">
                <div class="input-container">
                    <input type="url"
                           name="channel_url"
                           id="channel_url"
                           class="channel-input"
                           placeholder="Enter YouTube channel URL (e.g., https://youtube.com/@mkbhd)"
                           required
                           aria-label="YouTube Channel URL Input">
                    <svg class="input-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M22.54 6.42a2.78 2.78 0 0 0-1.94-2C18.88 4 12 4 12 4s-6.88 0-8.6.42a2.78 2.78 0 0 0-1.94 2A29 29 0 0 0 1 11.75a29 29 0 0 0 .54 5.33A2.78 2.78 0 0 0 3.46 19c1.72.42 8.6.42 8.6.42s6.88 0 8.6-.42a2.78 2.78 0 0 0 1.94-2A29 29 0 0 0 23 11.75a29 29 0 0 0-.46-5.33z"/>
                        <path d="M10 15.25l5-3.5-5-3.5v7z"/>
                    </svg>
                </div>
                <div class="input-hint">
                    Supported formats: <code>https://youtube.com/@channelname</code>
                </div>
            </div>



            <button type="submit" class="process-btn">
                <span class="btn-icon">ðŸš€</span>
                <span>Process Channel</span>
            </button>
        </form>

        <div id="processingContainer" class="processing-display" style="display: none;">
            <div class="processing-content">
                <div class="processing-avatar">
                    <div class="channel-card-spinner"></div>
                </div>
                <div class="processing-details">
                    <div class="processing-title">Processing Channel...</div>
                    <div class="progress-container">
                        <div class="progress-bar">
                            <div id="progressBarInner" class="progress-bar-inner" style="width: 0%;"></div>
                        </div>
                    </div>
                    <div id="progressText" class="progress-text">Starting...</div>
                </div>
            </div>
        </div>
        </div>
</div>

{% endblock %}

{% block page_scripts %}
<script>
// --- START: MODIFIED SCRIPT ---
document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('channelForm');
    const urlInput = document.getElementById('channel_url');
    const processingContainer = document.getElementById('processingContainer');
    const progressBar = document.getElementById('progressBarInner');
    const progressText = document.getElementById('progressText');

    const pollingIntervals = {};

    function stopPolling(taskId) {
        if (pollingIntervals[taskId]) {
            clearInterval(pollingIntervals[taskId]);
            delete pollingIntervals[taskId];
        }
    }

    // Helper function to toggle between the form and the progress bar
    function showFormView(showForm = true) {
        form.style.display = showForm ? 'block' : 'none';
        processingContainer.style.display = showForm ? 'none' : 'block';
    }

    function checkTaskStatus(taskId) {
        const processingCard = document.querySelector(`.channel-item-wrapper[data-task-id="${taskId}"]`);

        fetch(`/task_result/${taskId}`)
            .then(res => res.json())
            .then(data => {
                if (data.status === 'complete') {
                    stopPolling(taskId);
                    // Hide the main processing container and show the form again
                    showFormView(true);

                    const channelName = processingCard ? processingCard.dataset.channelName : null;
                    if (channelName) {
                        // Fetch final details to build the 'ready' card
                        fetch(`/api/channel_details/${channelName}`)
                            .then(res => res.json())
                            .then(details => {
                                if (details.current_channel && processingCard) {
                                    const newCard = document.createElement('div');
                                    newCard.className = 'channel-item-wrapper';
                                    newCard.dataset.channelId = details.current_channel.id;

                                    const thumbnailHtml = details.current_channel.channel_thumbnail
                                        ? `<img src="${details.current_channel.channel_thumbnail}" alt="${channelName}" class="channel-avatar">`
                                        : '';

                                    newCard.innerHTML = `
                                        <a href="/ask/channel/${channelName}" class="channel-link">
                                            ${thumbnailHtml}
                                            <span class="channel-name">${channelName}</span>
                                        </a>
                                        <button class="delete-btn" onclick="confirmDeleteChannel('${details.current_channel.id}', '${channelName}', this)" aria-label="Delete ${channelName}">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                                        </button>
                                    `;
                                    processingCard.replaceWith(newCard);
                                    showNotification(data.message || `Channel '${channelName}' is ready!`, 'success');
                                } else {
                                    // Fallback to reload if details fetch fails
                                    showNotification('Channel processed. Reloading page...', 'success');
                                    setTimeout(() => window.location.reload(), 1500);
                                }
                            })
                            .catch(() => {
                                showNotification('Channel processed. Reloading page...', 'success');
                                setTimeout(() => window.location.reload(), 1500);
                            });
                    } else {
                        // Fallback to reload if no channel name is found
                        showNotification('Channel processed. Reloading page...', 'success');
                        setTimeout(() => window.location.reload(), 1500);
                    }
                } else if (data.status === 'failed') {
                    stopPolling(taskId);
                    showNotification(data.message || 'A processing error occurred.', 'error');
                    if (processingCard) processingCard.remove();
                    showFormView(true); // Show form again
                } else {
                    // Update progress bar if the main container is visible
                    if (processingContainer.style.display !== 'none') {
                        if (progressBar) progressBar.style.width = `${data.progress || 0}%`;
                        if (progressText) progressText.textContent = data.message || 'Processing...';
                    }
                }
            })
            .catch(err => {
                console.error('Polling error:', err);
                stopPolling(taskId);
                if (processingCard) processingCard.remove();
                showFormView(true);
                showNotification('Error checking task status.', 'error');
            });
    }

    function submitChannelForm(channelUrl) {
        // Hide the form and show the progress bar container
        showFormView(false);

        const formData = new FormData();
        formData.append('channel_url', channelUrl);

        // Determine the target URL based on the checkbox for shared channels
        const isSharedCheckbox = document.getElementById('is_shared_channel');
        const isShared = isSharedCheckbox && isSharedCheckbox.checked;
        const targetUrl = isShared ? "{{ url_for('add_shared_channel') }}" : "{{ url_for('channel') }}";

        fetch(targetUrl, {
            method: 'POST',
            body: formData
        })
        .then(res => {
            if (!res.ok) {
                // When the response is not OK, we expect a JSON error object from our server.
                // We'll throw an error object that includes the JSON payload.
                return res.json().then(err => { throw err; });
            }
            return res.json();
        })
        .then(data => {
            if (data.status === 'processing' && data.task_id) {
                // --- NEW: Add processing card to sidebar ---
                const channelNameMatch = channelUrl.match(/@([a-zA-Z0-9_.-]+)/);
                const channelName = channelNameMatch ? channelNameMatch[1] : 'New Channel';
                const sidebarList = document.querySelector('.sidebar .channel-list');
                if (sidebarList) {
                    const newCard = document.createElement('div');
                    newCard.className = 'channel-item-wrapper processing';
                    newCard.dataset.taskId = data.task_id;
                    newCard.dataset.channelName = channelName;
                    newCard.innerHTML = `
                        <a href="#" class="channel-link" onclick="return false;">
                            <div class="channel-avatar-spinner"></div>
                            <span class="channel-name">${channelName}</span>
                        </a>
                        <div class="status-badge">Processing</div>
                    `;
                    sidebarList.appendChild(newCard);
                }
                // --- END NEW ---

                // Task started, begin polling for status updates
                pollingIntervals[data.task_id] = setInterval(() => checkTaskStatus(data.task_id), 3000);
                if (urlInput) urlInput.value = '';

            } else if (data.status === 'success') {
                // Handles cases where no background task is needed (e.g., re-adding)
                showNotification(data.message, 'success');
                setTimeout(() => window.location.reload(), 2000);

            } else {
                 throw new Error(data.message || 'Failed to start task.');
            }
        })
        .catch(error => {
            // The error object might have an 'action' property for specific UI responses
            if (error && error.action === 'show_upgrade_popup') {
                // This function should be globally available from base.html
                if (window.showUpgradePopup) {
                    window.showUpgradePopup(error.message);
                } else {
                    showNotification(error.message, 'error'); // Fallback
                }
            } else {
                const errorMessage = error.message || 'An unknown error occurred.';
                showNotification(errorMessage, 'error');
            }
            // On any error, show the form again
            showFormView(true);
        });
    }

    if (form) {
        form.addEventListener('submit', function (e) {
            e.preventDefault();
            const userIsLoggedIn = {{ 'true' if user else 'false' }};
            const channelUrl = urlInput.value.trim();

            if (!channelUrl) {
                showNotification('Please enter a valid channel URL.', 'error');
                return;
            }

            if (!userIsLoggedIn) {
                localStorage.setItem('action_after_login', JSON.stringify({ type: 'process_channel', url: channelUrl }));
                showLoginPopup();
            } else {
                submitChannelForm(channelUrl);
            }
        });
    }

    // This part handles processing a channel URL after a user logs in
    const userIsLoggedIn = {{ 'true' if user else 'false' }};
    if (userIsLoggedIn) {
        const pendingActionJSON = localStorage.getItem('action_after_login');
        if (pendingActionJSON) {
            const pendingAction = JSON.parse(pendingActionJSON);
            localStorage.removeItem('action_after_login');

            if (pendingAction.type === 'process_channel' && pendingAction.url) {
                if (urlInput) urlInput.value = pendingAction.url;
                submitChannelForm(pendingAction.url);
            }
        }
    }
});
// --- END: MODIFIED SCRIPT ---
</script>
{% endblock %}
