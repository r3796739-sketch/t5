{% extends "base.html" %}

{% block title %}Admin Dashboard{% endblock %}

{% block page_styles %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
{% endblock %}

{% block content %}
<div class="admin-container">
    <div class="page-header">
        <h1 class="page-title">Admin Dashboard</h1>
        <p class="page-subtitle">Manage users, communities, and plans.</p>
    </div>

    <div class="admin-section">
        <h2 class="section-title">Plan Management</h2>
        <div class="form-card">
            <h3 class="form-title">Create New Plan</h3>
            <form id="createPlanForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="plan_id">Plan ID</label>
                        <input type="text" id="plan_id" name="plan_id" placeholder="e.g., pro_tier" required>
                    </div>
                    <div class="form-group">
                        <label for="plan_name">Plan Name</label>
                        <input type="text" id="plan_name" name="plan_name" placeholder="e.g., Pro Tier" required>
                    </div>
                    <div class="form-group">
                        <label for="max_channels">Max Channels / Shared</label>
                        <input type="number" id="max_channels" name="max_channels" placeholder="e.g., 10" required>
                    </div>
                    <div class="form-group">
                        <label for="max_queries">Max Queries / Month</label>
                        <input type="number" id="max_queries" name="max_queries" placeholder="e.g., 5000" required>
                    </div>
                    <div class="form-group">
                        <label for="plan_type">Plan Type</label>
                        <select id="plan_type" name="plan_type" required>
                            <option value="user">Direct User Plan</option>
                            <option value="community">Community Plan</option>
                        </select>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">Create Plan</button>
            </form>
        </div>
    </div>

    <div class="admin-section">
        <h2 class="section-title">Whop Communities</h2>
        <div class="admin-grid">
            {% for community in communities %}
            <div class="admin-card">
                <div class="card-header">
                    <div class="card-info">
                        <div class="card-title">{{ community.owner.full_name or community.owner.email }}'s Community</div>
                        <div class="card-subtitle" title="{{ community.id }}">ID: {{ community.id[:8] }}...</div>
                    </div>
                    <div class="card-actions">
                        <button class="action-menu-btn" onclick="toggleActionMenu(this)">•••</button>
                        <div class="action-menu">
                            <div class="action-group">
                                <label>Set Plan</label>
                                <select id="community-plan-{{ community.id }}">
                                    {% for plan_id, plan_details in COMMUNITY_PLANS.items() %}
                                        <option value="{{ plan_id }}" {% if community.plan_id == plan_id %}selected{% endif %}>
                                            {{ plan_details.name }}
                                        </option>
                                    {% endfor %}
                                </select>
                                <button class="btn-secondary" onclick="setCurrentPlan('{{ community.id }}', 'community', document.getElementById('community-plan-{{ community.id }}').value)">Apply</button>
                            </div>
                            <div class="action-divider"></div>
                            <a href="#" onclick="removePlan('{{ community.id }}', 'community')">Revert to Default</a>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="stat-item"><span>Current Plan</span><span class="plan-badge">{{ community.plan_id }}</span></div>
                    <div class="stat-item"><span>Queries Used</span><span>{{ community.queries_used }} / {{ community.query_limit }}</span></div>
                    <div class="stat-item"><span>Shared Channels</span><span>{{ community.shared_channel_limit }}</span></div>
                </div>
            </div>
            {% else %}
            <p>No Whop communities found.</p>
            {% endfor %}
        </div>
    </div>

    <div class="admin-section">
        <div class="section-header">
            <h2 class="section-title">Creator Payouts</h2>
            <div class="search-wrapper">
                <form id="payoutSearchForm">
                    <input type="search" id="payoutSearchInput" name="q" placeholder="Search by email or payout ID..." value="{{ search_query or '' }}">
                </form>
            </div>
        </div>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Creator</th>
                        <th>Amount</th>
                        <th>Date Requested</th>
                        <th>Payout Details</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for payout in payouts %}
                    <tr>
                        <td class="creator-cell">
                            <span class="creator-name" title="{{ payout.creator.email }}">{{ payout.creator.full_name or payout.creator.email }}</span>
                            <span class="creator-email" title="{{ payout.id }}">ID: {{ payout.id[:8] }}...</span>
                        </td>
                        <td class="amount-cell"><strong>${{ "%.2f"|format(payout.amount_usd) }}</strong></td>
                        <td>{{ payout.requested_at.split('T')[0] }}</td>
                        <td class="payout-details-cell">
                            {% if payout.payout_destination_details %}
                                <div><strong>Name:</strong> {{ payout.payout_destination_details.name }}</div>
                                <div><strong>Acc No:</strong> {{ payout.payout_destination_details.account_number }}</div>
                                <div><strong>IFSC:</strong> {{ payout.payout_destination_details.ifsc }}</div>
                            {% else %}
                                <span class="text-muted">No Details Provided</span>
                            {% endif %}
                        </td>
                        <td><span class="status-badge status-{{ payout.status }}">{{ payout.status|title }}</span></td>
                        <td>
                            {% if payout.status == 'pending' and payout.payout_destination_details %}
                                <button class="btn-secondary" onclick="markPayoutAsPaid('{{ payout.id }}', this)">Mark as Paid</button>
                            {% else %}
                                <span>-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="6" class="empty-row">No payouts found matching your search.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="admin-section">
        <h2 class="section-title">Direct Users (Non-Whop)</h2>
        <div class="admin-grid">
            {% for user in non_whop_users %}
            <div class="admin-card">
                <div class="card-header">
                    <div class="card-info">
                        <div class="card-title">{{ user.full_name or user.email }}</div>
                        <div class="card-subtitle" title="{{ user.id }}">{{ user.email }}</div>
                    </div>
                    <div class="card-actions">
                        <button class="action-menu-btn" onclick="toggleActionMenu(this)">•••</button>
                        <div class="action-menu">
                            <div class="action-group">
                                <label>Set Plan</label>
                                <select id="user-plan-{{ user.id }}">
                                    {% for plan_id, plan_details in all_plans.items() %}
                                        {% if not plan_id.startswith('whop_') and plan_id not in ['admin_testing', 'community_member'] %}
                                            <option value="{{ plan_id }}" {% if user.direct_subscription_plan == plan_id or (not user.direct_subscription_plan and plan_id == 'free') %}selected{% endif %}>
                                                {{ plan_details.name }}
                                            </option>
                                        {% endif %}
                                    {% endfor %}
                                </select>
                                <button class="btn-secondary" onclick="setCurrentPlan('{{ user.id }}', 'user', document.getElementById('user-plan-{{ user.id }}').value)">Apply</button>
                            </div>
                             <div class="action-divider"></div>
                            <a href="#" onclick="removePlan('{{ user.id }}', 'user')">Revert to Default</a>
                            <a href="#" class="danger" onclick="deleteUser('{{ user.id }}', '{{ user.email }}')">Delete User</a>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="stat-item"><span>Current Plan</span><span class="plan-badge">{{ user.direct_subscription_plan or 'free' }}</span></div>
                    <div class="stat-item"><span>Queries Used</span><span>{{ user.usage.queries_this_month if user.usage else 0 }}</span></div>
                    <div class="stat-item"><span>Channels</span><span>{{ user.usage.channels_processed if user.usage else 0 }}</span></div>
                </div>
            </div>
            {% else %}
            <p>No direct users found.</p>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block page_scripts %}
    <script src="{{ url_for('static', filename='js/admin.js') }}"></script>
{% endblock %}