{% extends "base.html" %}

{% block title %}Admin Dashboard{% endblock %}

{% block page_styles %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
{% endblock %}

{% block content %}
<div class="admin-container">
    <div class="page-header">
        <h1 class="page-title">Admin Dashboard</h1>
        <p class="page-subtitle">Manage users, communities, and plans.</p>
    </div>

    <div class="admin-section">
        <h2 class="section-title">Plan Management</h2>
        <div class="form-card">
            <h3 class="form-title">Create New Plan</h3>
            <form id="createPlanForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="plan_id">Plan ID</label>
                        <input type="text" id="plan_id" name="plan_id" placeholder="e.g., pro_tier" required>
                    </div>
                    <div class="form-group">
                        <label for="plan_name">Plan Name</label>
                        <input type="text" id="plan_name" name="plan_name" placeholder="e.g., Pro Tier" required>
                    </div>
                    <div class="form-group">
                        <label for="max_channels">Max Channels / Shared</label>
                        <input type="number" id="max_channels" name="max_channels" placeholder="e.g., 10" required>
                    </div>
                    <div class="form-group">
                        <label for="max_queries">Max Queries / Month</label>
                        <input type="number" id="max_queries" name="max_queries" placeholder="e.g., 5000" required>
                    </div>
                    <div class="form-group">
                        <label for="plan_type">Plan Type</label>
                        <select id="plan_type" name="plan_type" required>
                            <option value="user">Direct User Plan</option>
                            <option value="community">Community Plan</option>
                        </select>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">Create Plan</button>
            </form>
        </div>
    </div>

<div class="admin-section">
    <h2 class="section-title">Creator Payouts</h2>
    <div class="payouts-list">
        {% for payout in payouts %}
        <div class="payout-card status-{{ payout.status }}">
            <div class="payout-header">
                <div class="creator-info">
                    <span class="creator-name">{{ payout.creator.full_name or payout.creator.email }}</span>
                    <span class="payout-date">Requested on {{ payout.requested_at.split('T')[0] }}</span>
                </div>
                <div class="payout-amount">
                    ${{ "%.2f"|format(payout.amount_usd) }}
                </div>
            </div>

            {% if payout.status == 'pending' and payout.creator.payout_details %}
            <div class="payout-details">
                <h4>Bank Account Details:</h4>
                <div class="bank-info">
                    <p><strong>Name:</strong> {{ payout.creator.payout_details.name }}</p>
                    <p><strong>Account No:</strong> {{ payout.creator.payout_details.account_number }}</p>
                    <p><strong>IFSC Code:</strong> {{ payout.creator.payout_details.ifsc }}</p>
                </div>
            </div>
            {% elif payout.status == 'pending' %}
            <div class="payout-details">
                <p class="text-muted">Creator has not provided their bank details yet.</p>
            </div>
            {% endif %}

            <div class="payout-footer">
                <span class="status-badge status-{{ payout.status }}">{{ payout.status|title }}</span>
                {% if payout.status == 'pending' and payout.creator.payout_details %}
                    <button class="btn-secondary" onclick="markPayoutAsPaid('{{ payout.id }}', this)">Mark as Paid</button>
                {% endif %}
            </div>
        </div>
        {% else %}
        <div class="payout-card">
            <p style="text-align: center; padding: 1rem; color: var(--text-secondary);">No pending payout requests.</p>
        </div>
        {% endfor %}
    </div>
</div>
    <div class="admin-section">
    <h2 class="section-title">Creator Payouts</h2>
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Creator</th>
                    <th>Amount</th>
                    <th>Date Requested</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for payout in payouts %}
                <tr>
                    <td title="{{ payout.creator.email }}">{{ payout.creator.full_name or payout.creator.email }}</td>
                    <td><strong>${{ "%.2f"|format(payout.amount_usd) }}</strong></td>
                    <td>{{ payout.requested_at.split('T')[0] }}</td>
                    <td><span class="status-badge status-{{ payout.status }}">{{ payout.status|title }}</span></td>
<td>
    {% if payout.status == 'pending' %}
        <button class="btn-secondary" onclick="initiatePayout('{{ payout.id }}', '{{ payout.creator_id }}', '{{ payout.amount_usd }}')">Pay with Razorpay</button>
    {% else %}
        <span>-</span>
    {% endif %}
</td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="5" style="text-align: center; padding: 2rem;">No payout requests yet.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
    <div class="admin-section">
        <h2 class="section-title">Direct Users (Non-Whop)</h2>
        <div class="admin-grid">
            {% for user in non_whop_users %}
            <div class="admin-card">
                <div class="card-header">
                    <div class="card-info">
                        <div class="card-title">{{ user.full_name or user.email }}</div>
                        <div class="card-subtitle" title="{{ user.id }}">{{ user.email }}</div>
                    </div>
                    <div class="card-actions">
                        <button class="action-menu-btn" onclick="toggleActionMenu(this)">•••</button>
                        <div class="action-menu">
                            <div class="action-group">
                                <label>Set Plan</label>
                                <select id="user-plan-{{ user.id }}">
                                    {% for plan_id, plan_details in all_plans.items() %}
                                        {% if not plan_id.startswith('whop_') and plan_id not in ['admin_testing', 'community_member'] %}
                                            <option value="{{ plan_id }}" {% if user.direct_subscription_plan == plan_id or (not user.direct_subscription_plan and plan_id == 'free') %}selected{% endif %}>
                                                {{ plan_details.name }}
                                            </option>
                                        {% endif %}
                                    {% endfor %}
                                </select>
                                <button class="btn-secondary" onclick="setCurrentPlan('{{ user.id }}', 'user', document.getElementById('user-plan-{{ user.id }}').value)">Apply</button>
                            </div>
                             <div class="action-divider"></div>
                            <a href="#" onclick="removePlan('{{ user.id }}', 'user')">Revert to Default</a>
                            <a href="#" class="danger" onclick="deleteUser('{{ user.id }}', '{{ user.email }}')">Delete User</a>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="stat-item"><span>Current Plan</span><span class="plan-badge">{{ user.direct_subscription_plan or 'free' }}</span></div>
                    <div class="stat-item"><span>Queries Used</span><span>{{ user.usage.queries_this_month if user.usage else 0 }}</span></div>
                    <div class="stat-item"><span>Channels</span><span>{{ user.usage.channels_processed if user.usage else 0 }}</span></div>
                </div>
            </div>
            {% else %}
            <p>No direct users found.</p>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block page_scripts %}
    <script src="{{ url_for('static', filename='js/admin.js') }}"></script>
{% endblock %}