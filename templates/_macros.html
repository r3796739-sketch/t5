{# This macro renders the channel card used on the main dashboard page #}
{% macro render_dashboard_processing_channel_card(channel_name) %}
<div class="channel-card processing">
    <div class="channel-card-link">
        <div class="channel-card-avatar-placeholder processing-placeholder">
            <div class="channel-card-spinner"></div>
        </div>
        <div class="channel-card-details">
            <div class="channel-card-title">{{ channel_name }}</div>
            <div class="channel-card-status">Processing...</div>
        </div>
    </div>
</div>
{% endmacro %}

{% macro render_dashboard_channel_card(channel, channel_name) %}
<div class="channel-card" data-channel-id="{{ channel.id }}">
    <a href="{{ url_for('ask', channel_name=channel_name) }}" class="channel-card-link">
        {% if channel.channel_thumbnail %}
        <img src="{{ channel.channel_thumbnail }}" alt="{{ channel_name }}" class="channel-card-avatar">
        {% else %}
        <span class="channel-card-avatar-placeholder">{{ channel_name[0] | upper }}</span>
        {% endif %}
        <div class="channel-card-details">
            <div class="channel-card-title">{{ channel_name }}</div>
        </div>
    </a>
    <button class="delete-channel-btn" onclick="confirmDeleteChannel('{{ channel.id }}', '{{ channel_name }}', this)" aria-label="Delete {{ channel_name }}">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
    </button>
</div>
{% endmacro %}


{# This macro renders a channel item in a processing state for the sidebar #}
{% macro render_sidebar_processing_channel_item(channel_name, task_id) %}
<div class="channel-item-wrapper processing" data-task-id="{{ task_id }}">
    <a href="#" class="channel-link" onclick="return false;">
        <div class="channel-avatar-spinner"></div>
        <span class="channel-name">{{ channel_name }}</span>
    </a>
    <div class="status-badge">Processing</div>
</div>
{% endmacro %}

{# This macro renders the channel item used in the sidebar #}
{% macro render_sidebar_channel_item(channel, channel_name, community_status=None) %}

    {# --- START: NEW LOGIC --- #}
    {% if channel.status in ['pending', 'processing'] %}
    <div class="channel-item-wrapper processing" data-task-id="{{ task_id }}">
        <a href="#" class="channel-link" onclick="return false;" title="This channel is currently being processed.">
            <div class="channel-avatar-spinner"></div>
            <span class="channel-name">{{ channel_name }}</span>
        </a>
        <div class="status-badge">Processing</div>
    </div>

    {% elif channel.status == 'failed' %}
    <div class="channel-item-wrapper failed" title="Processing failed for this channel. Please try adding it again.">
         <a href="#" class="channel-link" onclick="return false;">
            <span class="channel-name" style="color: var(--accent-error);">{{ channel_name }}</span>
        </a>
        <div class="status-badge" style="background-color: var(--accent-error); color: white;">Failed</div>
    </div>

    {% else %} {# This is the existing code for a 'ready' channel #}
    <div class="channel-item-wrapper {% if request.endpoint == 'ask' and request.view_args.get('channel_name') == channel_name %}active{% endif %}" data-channel-id="{{ channel.id }}">
        <a href="{{ url_for('ask', channel_name=channel_name) }}" class="channel-link">
            {% if channel.channel_thumbnail %}<img src="{{ channel.channel_thumbnail }}" alt="{{ channel_name }}" class="channel-avatar">{% endif %}
            <span class="channel-name">{{ channel_name }}</span>
        </a>

        {% set is_default_channel = community_status and community_status.default_channel_id == channel.id %}
        {% if not (is_default_channel and not user_status.is_active_community_owner) %}
        <button class="delete-btn" onclick="confirmDeleteChannel('{{ channel.id }}', '{{ channel_name }}', this)" aria-label="Delete {{ channel_name }}">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
        </button>
        {% endif %}
    </div>
    {% endif %}
    {# --- END: NEW LOGIC --- #}

{% endmacro %}

{# Pricing card macro remains unchanged #}
{% macro render_pricing_card(plan_details, current_plan=None, is_modal=False) %}
    {# ... (no changes needed in this macro) ... #}
{% endmacro %}

{# This macro renders the branded Discord bot management card #}
{% macro render_bot_card(bot) %}
<div class="bot-card" data-bot-id="{{ bot.id }}" data-status="{{ bot.status }}">
    <div class="bot-card-header">
        <img src="{{ bot.channel.channel_thumbnail or url_for('static', filename='images/default_avatar.png') }}" alt="Bot Avatar" class="bot-avatar">
        <div class="bot-info">
            <div class="name">{{ bot.channel.channel_name or 'Branded Bot' }}</div>
            <div class="link">Linked to {{ bot.channel.channel_name or 'YouTube Channel' }}</div>
        </div>
    </div>
    <div class="bot-card-body">
        <div class="status-indicator">
            <div class="status-dot {{ bot.status }}"></div>
            <span class="status-text">{{ bot.status|capitalize }}</span>
        </div>
    </div>
    <div class="bot-card-footer">
        {# --- MODIFIED BUTTON --- #}
        <button class="btn action-btn" onclick="toggleBot('{{ bot.id }}', this)" {% if bot.status == 'connecting' %}disabled{% endif %}>
            {% if bot.status == 'online' %}Deactivate{% else %}Activate{% endif %}
        </button>
        <button class="btn btn-secondary" onclick="openBotShareModal('{{ bot.invite_link }}', '{{ bot.channel.channel_name or 'Branded Bot' }}')">Share</button>
        <button class="btn btn-secondary" onclick="openEditBotModal('{{ bot.id }}')">Edit</button>
        <button class="btn btn-danger" onclick="confirmDeleteBot('{{ bot.id }}', '{{ bot.channel.channel_name or 'Branded Bot' }}', this)">Delete</button>
    </div>
</div>
{% endmacro %}