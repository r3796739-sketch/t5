{% extends "base.html" %}

{% block title %}Ask Questions - YoppyChat AI{% endblock %}

{% block page_styles %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/ask.css') }}">
    <script>
        // Pass server-side data to JavaScript
        const IS_TEMPORARY_SESSION = {{ is_temporary_session|tojson or 'false' }};
        const NOTICE_DATA = {{ notice|tojson or 'null' }};
    </script>
{% endblock %}

{% block content %}
{% set notice = notice or {} %}

<div class="mobile-header">
    <div class="mobile-header-left">
        <button class="hamburger" id="hamburgerBtnMobile" aria-label="Toggle Sidebar">
            <span></span><span></span><span></span>
        </button>

        {% if channel_name and current_channel %}
        <div class="mobile-header-channel">
            <img src="{{ current_channel.channel_thumbnail }}" alt="{{ channel_name }}" class="mobile-channel-avatar">
            <div class="mobile-channel-text-details">
                <span class="mobile-channel-title">{{ channel_name }}</span>
                {% if current_channel.subscriber_count %}
                    <span class="mobile-channel-subscribers">
                        {{ current_channel.subscriber_count | format_subscribers }} Subscribers
                    </span>
                {% endif %}
            </div>
        </div>
        {% else %}
        <div class="mobile-header-channel">
            <span class="mobile-channel-title">General Q&A</span>
        </div>
        {% endif %}
    </div>

    <div class="header-actions">
        {% if user %}
            <button id="kebab-menu-btn-mobile" class="kebab-menu-button" aria-label="More options">
                <svg class="icon-default" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"></circle><circle cx="12" cy="5" r="1"></circle><circle cx="12" cy="19" r="1"></circle></svg>
            </button>
            <div id="dropdown-menu-mobile" class="dropdown-menu">
                {% if channel_name and current_channel %}
                    <a href="#" onclick="refreshChannel('{{ current_channel.id }}', this); return false;">Update Channel</a>
                    <a href="#" onclick="clearChat('{{ channel_name }}'); return false;">Clear Chat</a>
                    {% if not session.get('active_community_id') %}
                    <a href="#" onclick="openShareModal(); return false;">Share</a>
                    <hr>
                    <a href="{{ current_channel.channel_url }}" target="_blank" rel="noopener noreferrer">View on YouTube</a>
                    {% endif %}
                {% else %}
                    <a href="#" onclick="clearChat('general'); return false;">Clear Chat</a>
                {% endif %}
            </div>
        {% endif %}
    </div>
</div>


<div
    class="desktop-chat-layout"
    id="chat-page-data"
    data-channel-name="{{ channel_name or '' }}"
    data-channel-thumbnail="{{ current_channel.channel_thumbnail if current_channel else '' }}"
>
    <div class="chat-column">
        <div class="chat-wrapper">

            <div class="c-banner-notice" id="c-banner-notice" style="display: none;">
                <div class="notice-content">
                    <p id="c-banner-notice-text"></p>
                    <a href="#" onclick="event.preventDefault(); showPricingModal();" class="btn-upgrade" id="c-banner-notice-btn">Upgrade Plan</a>
                </div>
                <button class="notice-close-btn">&times;</button>
            </div>

            <div id="conversation-history" class="chat-container {% if not history %}is-empty{% endif %}" role="log" aria-live="polite">

                {# Show example questions only if there is no history AND the user is logged out #}
                {% if not history or not user %}
                    <div class="example-questions-container">
                        <div class="example-question" onclick="askExample(this)">What are your most popular videos about?</div>
                        <div class="example-question" onclick="askExample(this)">Summarize your latest video for me.</div>
                        <div class="example-question" onclick="askExample(this)">What tools do you recommend for beginners?</div>
                    </div>
                {% endif %}

                {% for qa in history %}
                <div class="qna-pair">
                    <div class="question-box">
                        <div class="question-content">{{ qa.question }}</div>
                    </div>

                    <div class="answer-box">
<div class="answer-header">
    {% if channel_name and current_channel and current_channel.channel_thumbnail %}
        <div class="answer-avatar-container avatar-container">
            <img src="{{ current_channel.channel_thumbnail }}" alt="{{ channel_name }}" class="answer-avatar">
            <span class="ai-badge">AI</span>
        </div>
    {% else %}
        <div class="answer-avatar-container avatar-container">
            <div class="answer-avatar-placeholder">ðŸ¤–</div>
            <span class="ai-badge">AI</span>
        </div>
    {% endif %}
    <span class="answer-label">
        {% if channel_name %}{{ channel_name }}{% else %}Answer{% endif %}
    </span>

</div>
                        <div class="answer-content">{{ qa.answer|markdown }}</div>

                        <div class="typing-container">
                            <div class="typing-indicator">
                                <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>
                            </div>
                        </div>

                        <div class="sources-section">
                            <div class="source-buttons">
                                {% if qa.sources %}
                                    <button class="toggle-sources-btn" onclick="toggleSources(this)">
                                        <svg class="sources-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"><path fill="currentColor" d="M4,6H2V20a2,2 0 0,0 2,2H18V18H4V6M20,2H8A2,2 0 0,0 6,4V16a2,2 0 0,0 2,2H20a2,2 0 0,0 2-2V4a2,2 0 0,0-2-2Z"></path></svg>
                                        Sources ({{ qa.sources|length }})
                                        <span class="toggle-indicator">â–¼</span>
                                    </button>
                                {% endif %}
                                {% if loop.last %}
                                    <button class="toggle-sources-btn regenerate-btn-js" onclick="regenerateAnswer(this)">
                                        <svg class="sources-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="1 4 1 10 7 10"></polyline><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path></svg>
                                        Regenerate
                                    </button>
                                {% endif %}
                                <button class="copy-answer-btn" onclick="copyAnswer(this)" data-tooltip="Copy answer">
                                <svg class="icon-copy-default" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                                <svg class="icon-copy-check" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                                </button>
                            </div>
                            {% if qa.sources %}
                                <div class="sources-list" style="display: none;">
                                    {% for source in qa.sources %}
                                    <div class="source-item">
                                        <a href="{{ source.url }}" target="_blank" class="source-link">
                                            <span class="source-title">{{ source.title }}</span>
                                        </a>
                                    </div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <form id="questionForm" class="question-form" role="form">
                <div class="form-group">

                    <div class="textarea-wrapper">
                        <textarea
                            name="question"
                            id="questionText"
                            class="question-textarea"
                            rows="1"
                            placeholder="Ask a question..."
                            required
                            maxlength="1000"
                        ></textarea>
                        <div class="textarea-actions">
                            <span class="char-count">0/1000</span>
                            <button type="submit" id="submitBtn" class="submit-btn" disabled>
                                <svg class="submit-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M2,21L23,12L2,3V10L17,12L2,14V21Z" /></svg>
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <aside class="chat-sidebar-right">
        {% if channel_name and current_channel %}
        <div class="channel-profile-card">
            <div class="profile-header">
                <div class="profile-avatar">
                    <img src="{{ current_channel.channel_thumbnail }}" alt="{{ channel_name }}">
                    <span class="ai-badge">AI</span>
                </div>
                <div class="profile-info">
                    <h2 class="profile-name">{{ channel_name }}</h2>
                        <p class="profile-description">
                            {% if current_channel.summary %}
                                {{ current_channel.summary }}
                            {% else %}
                                AI assistant powered by the content of the {{ channel_name }} YouTube channel.
                            {% endif %}
                        </p>
                </div>
            </div>



            <div class="profile-actions-new">
                {% if not session.get('active_community_id') %}
                <button onclick="openShareModal()" class="action-btn-primary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg>
                    <span>Share</span>
                </button>
                {% endif %}
                <div class="secondary-actions">
                    <a href="{{ current_channel.channel_url }}" target="_blank" rel="noopener noreferrer" class="action-btn-secondary" data-tooltip="View on YouTube">
                         <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22.54 6.42a2.78 2.78 0 0 0-1.94-2C18.88 4 12 4 12 4s-6.88 0-8.6.42a2.78 2.78 0 0 0-1.94 2A29 29 0 0 0 1 11.75a29 29 0 0 0 .54 5.33A2.78 2.78 0 0 0 3.46 19c1.72.42 8.6.42 8.6.42s6.88 0 8.6-.42a2.78 2.78 0 0 0 1.94-2A29 29 0 0 0 23 11.75a29 29 0 0 0-.46-5.33z"></path><polygon points="9.75 15.02 15.5 11.75 9.75 8.48 9.75 15.02"></polygon></svg>
                    </a>
                    <button onclick="refreshChannel('{{ current_channel.id }}', this);" class="action-btn-secondary" data-tooltip="Update">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></svg>
                    </button>
                    <button onclick="clearChat('{{ channel_name }}');" class="action-btn-secondary" data-tooltip="Clear Chat">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18m-2 0v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                    </button>
                </div>
            </div>


            {# This admin toggle logic is already safe #}
            {% if user_status.is_active_community_owner and current_channel.community_id == user_status.active_community_id and current_channel.creator_id == user.id %}
            <div class="admin-channel-settings">
                <div class="setting-row">
                    <div class="setting-label">
                        <label for="shareToggle">Share with Community</label>
                        <p>When shared, all community members can see and chat with this channel.</p>
                    </div>
                    <label class="theme-switch large-switch">
                        <input type="checkbox" id="shareToggle" {% if current_channel.is_shared %}checked{% endif %} onchange="toggleChannelPrivacy('{{ current_channel.id }}', this.checked)">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
            {% endif %}

            {% if current_channel.topics %}
            <div class="profile-topics">
                <h3 class="topics-title">Popular Topics</h3>
                <div class="topics-tags">
                    {% for topic in current_channel.topics %}
                    <span class="tag">{{ topic }}</span>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

        </div>
        {% else %}
        <div class="general-qa-header" role="banner">
            <div class="qa-header-content">
                <div class="qa-header-main">
                    <h1 class="qa-title">General Q&A</h1>
                </div>
                {# FIX: Only show clear chat button if logged in #}
                {% if user %}
                <button onclick="clearChat('general')" class="clear-chat-btn">
                    <span class="reset-icon">ðŸ”„</span>
                </button>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </aside>
</div>



<div id="shareModal" class="login-popup-overlay">
    <div class="login-popup-content" style="max-width: 500px;">
        <button class="login-popup-close-btn" onclick="closeShareModal()">&times;</button>
        <h3 class="login-popup-title">Share Conversation</h3>
        <p class="login-popup-subtitle" id="shareModalSubtitle">Share a link to this AI assistant.</p>

        <div class="link-copy-wrapper" id="linkCopyWrapper" onclick="copyShareLinkFromModal(this)">
            <input type="text" id="shareLinkInput" readonly>
            <div class="copy-action">
                <span class="copy-text">Copy</span>
                <svg class="icon-copy-default" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                <svg class="icon-copy-check" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
            </div>
        </div>
        <hr class="modal-divider">

<div style="text-align: left; margin-top: 1rem;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
        <label for="includeHistoryToggle" style="font-weight: 600; color: var(--text-primary); font-size: 1rem;">Include chat history</label>
        <label class="theme-switch large-switch">
            <input type="checkbox" id="includeHistoryToggle">
            <span class="slider"></span>
        </label>
    </div>
    <p style="font-size: 0.875rem; color: var(--text-secondary); margin: 0; line-height: 1.5;">Generates a new link that includes a snapshot of the current conversation.</p>
</div>
</div>
{% endblock %}
{% block page_scripts %}
    {# Your existing script tag for ask.js can stay here #}
    <script src="{{ url_for('static', filename='js/ask.js') }}"></script>

    {# --- START: ADD THIS NEW SCRIPT BLOCK --- #}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const noticeBanner = document.getElementById('c-banner-notice');
            const noticeText = document.getElementById('c-banner-notice-text');
            const noticeBtn = document.getElementById('c-banner-notice-btn');

            if (NOTICE_DATA && noticeBanner && noticeText && noticeBtn) {
                noticeText.innerHTML = NOTICE_DATA.message;

                if (NOTICE_DATA.action === 'add_channel') {
                    noticeBtn.textContent = NOTICE_DATA.button_text;
                    noticeBtn.onclick = (event) => {
                        event.preventDefault();
                        addSharedChannel(NOTICE_DATA.channel_id, NOTICE_DATA.channel_name, noticeBtn);
                    };
                }
                // The 'showUpgrade' logic is already handled by your existing ask.js
                noticeBanner.style.display = 'flex';
            }
        });

        function addSharedChannel(channelId, channelName, buttonElement) {
            buttonElement.disabled = true;
            buttonElement.textContent = 'Adding...';

            fetch(`/api/add_shared_channel/${channelId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(res => {
                if (!res.ok) { return res.json().then(err => Promise.reject(err)); }
                return res.json();
            })
            .then(data => {
                if (data.status === 'success' || data.status === 'already_exists') {
                    showNotification(data.message, 'success');
                    // Redirect to the user's permanent chat page for this channel
                    window.location.href = `/ask/channel/${encodeURIComponent(channelName)}`;
                }
            })
            .catch(error => {
                if (error.status === 'limit_reached') {
                    showPricingModal(); // Open the upgrade modal
                } else {
                    showNotification(error.message || 'An error occurred.', 'error');
                }
                buttonElement.disabled = false;
                buttonElement.textContent = 'Save this Channel';
            });
        }
    </script>
    {# --- END: ADD THIS NEW SCRIPT BLOCK --- #}
{% endblock %}
